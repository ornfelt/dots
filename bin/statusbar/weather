#!/usr/bin/bash
#curl -sf "wttr.in/Nizhniy_Novgorod?format=1" | sed -r 's/^.{4}//' | tee "$HOME/.local/share/weatherreport" || exit 1 ; #this exit will only work if tee (or before my changes, sed with output redirection) returns anything other than zero, if curl ends with an error this exit will not be called

case $BLOCK_BUTTON in
	1) "$TERMINAL" -e sh -c "curl -sf 'wttr.in/Uppsala'; zsh" ;;
	2) rofi -theme "~/.config/rofi/themes/gruvbox/gruvbox-dark.rasi" -e "Weather clicked 2" ;;
	3) pkill -RTMIN+5 dwmblocks ;;
	4) rofi -theme "~/.config/rofi/themes/gruvbox/gruvbox-dark.rasi" -e "Weather clicked 4" ;;
	5) rofi -theme "~/.config/rofi/themes/gruvbox/gruvbox-dark.rasi" -e "Weather clicked 5" ;;
	6) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

WIFI_NAME=$(iwgetid -r | tr '[:upper:]' '[:lower:]')
CITY="Stockholm" # Default

CACHE="$HOME/.local/share/weatherreport"

# If we have no network, show cached value (if any) and exit.
# (Uses the "default route" check; simple and fast)
if ! ip route get 1.1.1.1 >/dev/null 2>&1; then
    if [[ -s "$CACHE" ]]; then
        cat "$CACHE"
    else
        echo "N/A"
    fi
    exit 0
fi

# Determine the city based on WiFi SSID (not really accurate but hey...)
# Not needed with the gustavsberg -> stockholm replacement below...
if [[ "$WIFI_NAME" == *"nätet"* || "$WIFI_NAME" == *"telia"* ]]; then
    CITY="Stockholm"
else
    data=$(curl -s https://ipinfo.io/json)
    CITY=$(echo "$data" | jq -r '.city')
fi

if [[ "${CITY,,}" == "gustavsberg" ]]; then
    CITY="Stockholm"
fi
#echo "CITY: $CITY"

#WEATHER_REPORT=$(curl -sf --max-time 2 "wttr.in/Uppsala?format=1" | sed -r 's/^.{3}//;s/^ *//g;s/C//g')
WEATHER_REPORT=$(curl -sf --max-time 2 "wttr.in/${CITY}?format=1" | sed -r 's/^.{3}//;s/^ *//g;s/C//g')

validate_weather() {
    local weather="$1"
    if [[ "$weather" =~ [0-9] ]] && [[ ${#weather} -le 10 ]]; then
        return 0
    else
        return 1
    fi
}

if validate_weather "$WEATHER_REPORT"; then
    #echo "$WEATHER_REPORT"
    #echo "$WEATHER_REPORT" > "$CACHE"
    echo "$WEATHER_REPORT" | tee "$CACHE"
    #echo "$CITY $WEATHER_REPORT" | tee "$CACHE"
else
    #echo "USING FALLBACK"
    #FALLBACK_OUTPUT=$(python ~/.local/bin/statusbar/weather_py.py)
    #echo "$FALLBACK_OUTPUT" > "$CACHE"
    #echo "$FALLBACK_OUTPUT"
    #python ~/.local/bin/statusbar/weather_py.py "$CITY" | tee "$CACHE"
    FALLBACK_OUTPUT=$(python ~/.local/bin/statusbar/weather_py.py "$CITY")
    if validate_weather "$FALLBACK_OUTPUT"; then
        echo "$FALLBACK_OUTPUT" | tee "$CACHE"
        #echo "$CITY $FALLBACK_OUTPUT" | tee "$CACHE"
    else
        cat "$CACHE"
    fi
fi

#
# old code (kept for reference)
#
# CACHE="$HOME/.local/share/weatherreport"
# STR=$(curl -sf "wttr.in/Uppsala?format=1" | sed -r 's/^.{4}//')
# #STR=$(curl -sf "wttr.in/Uppsala" | grep -Eo -m 1 '(\+|\-)[0-9]+' | head -1)
# SUB='location'
# if [[ "$STR" == *"$SUB"* ]]; then
# 	#echo " -1"
# 	sudo cat ~/.local/share/weatherreport
# else
# 	#curl -sf "wttr.in/Uppsala" | grep -Eo -m 1 '(\+|\-|[0-9])[0-9]+' | head -1 | tee "$CACHE"
# 
# 	curl -sf "wttr.in/Uppsala?format=1" | sed -r 's/^.{3}//;s/^ *//g;s/C//g' | tee "$CACHE"
# 	# curl -sf "wttr.in/Uppsala?format=1" | sed -r 's/^.{4}//;s/^ *//g;s/C//g' | tee "$CACHE"
# 	#echo "+20°" | tee "$CACHE"
# 
# 	if [ -z "$STR" ]; then
# 		python ~/.local/bin/statusbar/weather_py.py | tee "$CACHE"
# 	fi
# fi

